name: Build and Deploy Besend

on:
  push:
    branches:
      - main
    paths:
      - 'cmd/**'
      - 'pkg/**'
      - 'api/**'
      - 'internal/**'
      - 'Dockerfile.*'
      - 'k8s/**'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  OPERATOR_IMAGE: bruno74t/besend-operator
  API_IMAGE: bruno74t/besend-api

jobs:
  build-operator:
    name: Build Operator Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD_SYMBOLS_ALLOWED }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.OPERATOR_IMAGE }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Build and push operator
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.operator
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.OPERATOR_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.OPERATOR_IMAGE }}:buildcache,mode=max

  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD_SYMBOLS_ALLOWED }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.API_IMAGE }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.API_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.API_IMAGE }}:buildcache,mode=max

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build-operator, build-api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Get short SHA
        id: vars
        run: echo "SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Update image tags in manifests
        run: |
          # Update operator image
          sed -i "s|image: bruno74t/besend-operator:.*|image: bruno74t/besend-operator:${{ steps.vars.outputs.SHORT_SHA }}|g" k8s/operator-deployment.yaml
          
          # Update API image
          sed -i "s|image: bruno74t/besend-api:.*|image: bruno74t/besend-api:${{ steps.vars.outputs.SHORT_SHA }}|g" k8s/api-deployment.yaml

      - name: Deploy to Kubernetes
        run: |
          # Apply namespace (idempotent)
          kubectl apply -f k8s/namespace.yaml
          
          # Apply secrets (only if not exists)
          kubectl get secret besend-postgres -n besend || kubectl apply -f k8s/postgres-secret.yaml
          
          # Deploy PostgreSQL (idempotent)
          kubectl apply -f k8s/postgres-statefulset.yaml
          
          # Wait for PostgreSQL
          kubectl wait --for=condition=ready pod -l app=postgres -n besend --timeout=300s || true
          
          # Deploy operator
          kubectl apply -f k8s/operator-rbac.yaml
          kubectl apply -f k8s/operator-deployment.yaml
          
          # Deploy API
          kubectl apply -f k8s/api-deployment.yaml
          
          # Restart deployments to pick up new images
          kubectl rollout restart deployment/besend-operator -n besend
          kubectl rollout restart deployment/besend-api -n besend
          
          # Wait for rollout
          kubectl rollout status deployment/besend-operator -n besend --timeout=300s
          kubectl rollout status deployment/besend-api -n besend --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n besend
          
          echo "=== Services ==="
          kubectl get svc -n besend
          
          echo "=== Operator Logs (last 20 lines) ==="
          kubectl logs -n besend -l app=besend-operator --tail=20 || true
          
          echo "=== API Logs (last 20 lines) ==="
          kubectl logs -n besend -l app=besend-api --tail=20 || true

      - name: Get LoadBalancer IP
        run: |
          echo "=== API Endpoint ==="
          kubectl get svc besend-api -n besend -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
          echo ""
